{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _typeof = require(\"@babel/runtime/helpers/typeof\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.defaultProps = exports.UserList = exports.ConnectedUserList = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _reactUtils = require(\"@opensrp/react-utils\");\n\nvar _antd = require(\"antd\");\n\nvar _keycloakService = require(\"@opensrp/keycloak-service\");\n\nvar _reactRedux = require(\"react-redux\");\n\nvar _reduxReducerRegistry = _interopRequireDefault(require(\"@onaio/redux-reducer-registry\"));\n\nvar _icons = require(\"@ant-design/icons\");\n\nvar _user = require(\"../../ducks/user\");\n\nvar _constants = require(\"../../constants\");\n\nvar _mls = require(\"../../mls\");\n\nvar _utils = require(\"./utils\");\n\nvar _sessionReducer = require(\"@onaio/session-reducer\");\n\nvar _reactRouter = require(\"react-router\");\n\nvar _notifications = require(\"@opensrp/notifications\");\n\nvar _TableActions = require(\"./TableActions\");\n\nvar _UserDetails = require(\"../UserDetails\");\n\nvar _rbac = require(\"@opensrp/rbac\");\n\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\n\nfunction _interopRequireWildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || _typeof(obj) !== \"object\" && typeof obj !== \"function\") {\n    return {\n      \"default\": obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache(nodeInterop);\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj[\"default\"] = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {\n      (0, _defineProperty2[\"default\"])(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n}\n\n_reduxReducerRegistry[\"default\"].register(_user.reducerName, _user.reducer);\n\nvar defaultProps = {\n  serviceClass: _keycloakService.KeycloakService,\n  fetchKeycloakUsersCreator: _user.fetchKeycloakUsers,\n  removeKeycloakUsersCreator: _user.removeKeycloakUsers,\n  keycloakUsers: [],\n  keycloakBaseURL: '',\n  opensrpBaseURL: '',\n  extraData: {},\n  usersPageSize: 20\n};\nexports.defaultProps = defaultProps;\n\nvar UserList = function UserList(props) {\n  var _getQueryParams$SEARC;\n\n  var serviceClass = props.serviceClass,\n      fetchKeycloakUsersCreator = props.fetchKeycloakUsersCreator,\n      removeKeycloakUsersCreator = props.removeKeycloakUsersCreator,\n      keycloakBaseURL = props.keycloakBaseURL,\n      opensrpBaseURL = props.opensrpBaseURL,\n      extraData = props.extraData,\n      usersPageSize = props.usersPageSize;\n  var history = (0, _reactRouter.useHistory)();\n\n  var _useTranslation = (0, _mls.useTranslation)(),\n      t = _useTranslation.t;\n\n  var searchParam = (_getQueryParams$SEARC = (0, _reactUtils.getQueryParams)(props.location)[_constants.SEARCH_QUERY_PARAM]) !== null && _getQueryParams$SEARC !== void 0 ? _getQueryParams$SEARC : '';\n\n  var _useState = (0, _react.useState)(),\n      _useState2 = (0, _slicedToArray2[\"default\"])(_useState, 2),\n      sortedInfo = _useState2[0],\n      setSortedInfo = _useState2[1];\n\n  var _useState3 = (0, _react.useState)(null),\n      _useState4 = (0, _slicedToArray2[\"default\"])(_useState3, 2),\n      userDetails = _useState4[0],\n      setUserDetails = _useState4[1];\n\n  var _useState5 = (0, _react.useState)(false),\n      _useState6 = (0, _slicedToArray2[\"default\"])(_useState5, 2),\n      openDetails = _useState6[0],\n      setOpenDetails = _useState6[1];\n\n  function FetchData(_x, _x2, _x3) {\n    return _FetchData.apply(this, arguments);\n  }\n\n  function _FetchData() {\n    _FetchData = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee4(page, pageSize, searchquery) {\n      var filterParams, usersService, keycloakUsers;\n      return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              filterParams = {\n                first: page * pageSize - pageSize,\n                max: pageSize\n              };\n              if (searchquery) filterParams = _objectSpread(_objectSpread({}, filterParams), {}, {\n                search: searchParam\n              });\n              usersService = new serviceClass(_constants.KEYCLOAK_URL_USERS, keycloakBaseURL);\n              _context4.next = 5;\n              return usersService.list(filterParams);\n\n            case 5:\n              keycloakUsers = _context4.sent;\n              fetchKeycloakUsersCreator(keycloakUsers, true);\n              return _context4.abrupt(\"return\", keycloakUsers);\n\n            case 8:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n    return _FetchData.apply(this, arguments);\n  }\n\n  var isSearchActive = searchParam && searchParam.length;\n\n  var fetchPractitioner = function () {\n    var _ref = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee(userId) {\n      var serve, practitioner;\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              serve = new _reactUtils.OpenSRPService(_constants.OPENSRP_CREATE_PRACTITIONER_ENDPOINT, opensrpBaseURL);\n              _context.prev = 1;\n              _context.next = 4;\n              return serve.read(userId);\n\n            case 4:\n              practitioner = _context.sent;\n              return _context.abrupt(\"return\", practitioner);\n\n            case 8:\n              _context.prev = 8;\n              _context.t0 = _context[\"catch\"](1);\n              (0, _notifications.sendErrorNotification)(t('There was a problem fetching Practitioner tied to this User'));\n              return _context.abrupt(\"return\", undefined);\n\n            case 12:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[1, 8]]);\n    }));\n\n    return function fetchPractitioner(_x4) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  var fetchAssignedTeams = function () {\n    var _ref2 = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee2(practitionerId) {\n      var serve, organizations;\n      return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              serve = new _reactUtils.OpenSRPService(_constants.ORGANIZATION_BY_PRACTITIONER, opensrpBaseURL);\n              _context2.prev = 1;\n              _context2.next = 4;\n              return serve.read(practitionerId);\n\n            case 4:\n              organizations = _context2.sent;\n              return _context2.abrupt(\"return\", organizations);\n\n            case 8:\n              _context2.prev = 8;\n              _context2.t0 = _context2[\"catch\"](1);\n              (0, _notifications.sendErrorNotification)(t('There was a problem fetching teams assigned to Practitioner'));\n              return _context2.abrupt(\"return\", []);\n\n            case 12:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[1, 8]]);\n    }));\n\n    return function fetchAssignedTeams(_x5) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var setDetailsCallback = function () {\n    var _ref3 = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee3(keycloakUser) {\n      return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              onCloseCallback();\n              setOpenDetails(true);\n              fetchPractitioner(keycloakUser.id).then(function (practitioner) {\n                if (practitioner) {\n                  fetchAssignedTeams(practitioner.identifier).then(function (assignedTeams) {\n                    setUserDetails({\n                      keycloakUser: keycloakUser,\n                      practitioner: practitioner,\n                      assignedTeams: assignedTeams\n                    });\n                  })[\"catch\"](function () {\n                    (0, _notifications.sendErrorNotification)(t('There was a problem fetching assigned teams'));\n                  });\n                } else {\n                  setUserDetails({\n                    keycloakUser: keycloakUser,\n                    practitioner: practitioner,\n                    assignedTeams: []\n                  });\n                }\n              })[\"catch\"](function () {\n                (0, _notifications.sendErrorNotification)(t('There was a problem fetching practitioner'));\n              });\n\n            case 3:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    }));\n\n    return function setDetailsCallback(_x6) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var onCloseCallback = function onCloseCallback() {\n    setUserDetails(null);\n    setOpenDetails(false);\n  };\n\n  return _react[\"default\"].createElement(\"section\", {\n    className: \"content-section\"\n  }, _react[\"default\"].createElement(_reactUtils.PageHeader, {\n    title: t('User Management')\n  }), _react[\"default\"].createElement(_antd.Row, {\n    className: \"list-view\"\n  }, _react[\"default\"].createElement(_antd.Col, {\n    className: \"main-content\",\n    span: openDetails ? 19 : 24\n  }, _react[\"default\"].createElement(\"div\", {\n    className: \"main-content__header\"\n  }, _react[\"default\"].createElement(_reactUtils.SearchForm, {\n    defaultValue: (0, _reactUtils.getQueryParams)(props.location)[_constants.SEARCH_QUERY_PARAM],\n    onChange: (0, _reactUtils.createChangeHandler)(_constants.SEARCH_QUERY_PARAM, props),\n    size: 'middle'\n  }), _react[\"default\"].createElement(_rbac.RbacCheck, {\n    permissions: ['iam_user.create']\n  }, _react[\"default\"].createElement(_antd.Space, {\n    style: {\n      marginBottom: 16,\n      \"float\": 'right'\n    }\n  }, _react[\"default\"].createElement(_antd.Button, {\n    type: \"primary\",\n    className: \"create-user\",\n    onClick: function onClick() {\n      return history.push(_constants.URL_USER_CREATE);\n    }\n  }, _react[\"default\"].createElement(_icons.PlusOutlined, null), t('Add User'))))), _react[\"default\"].createElement(_antd.Space, null, _react[\"default\"].createElement(_reactUtils.PaginateData, {\n    queryFn: FetchData,\n    onError: function onError() {\n      return (0, _notifications.sendErrorNotification)(t('There was a problem fetching Users'));\n    },\n    queryPram: {\n      searchParam: searchParam\n    },\n    pageSize: usersPageSize,\n    queryid: _constants.UserQueryId,\n    total: function total() {\n      var usersCountService = new serviceClass(\"\".concat(_constants.KEYCLOAK_URL_USERS_COUNT), keycloakBaseURL);\n      var filterParams = undefined;\n      if (isSearchActive) filterParams = {\n        search: searchParam\n      };\n      return usersCountService.list(filterParams);\n    }\n  }, function (tableProps) {\n    return _react[\"default\"].createElement(_reactUtils.TableLayout, (0, _extends2[\"default\"])({}, tableProps, {\n      columns: (0, _utils.getTableColumns)(t, sortedInfo),\n      dataKeyAccessor: \"id\",\n      onChange: function onChange(_, __, sorter) {\n        return setSortedInfo(sorter);\n      },\n      actions: {\n        title: 'Actions',\n        render: function render(_, record) {\n          var tableActionsProps = {\n            removeKeycloakUsersCreator: removeKeycloakUsersCreator,\n            keycloakBaseURL: keycloakBaseURL,\n            opensrpBaseURL: opensrpBaseURL,\n            record: record,\n            extraData: extraData,\n            setDetailsCallback: setDetailsCallback\n          };\n          return _react[\"default\"].createElement(_TableActions.TableActions, tableActionsProps);\n        }\n      }\n    }));\n  }))), openDetails ? _react[\"default\"].createElement(_antd.Col, {\n    className: \"pl-3\",\n    span: 5\n  }, _react[\"default\"].createElement(_UserDetails.UserDetails, (0, _extends2[\"default\"])({\n    onClose: function onClose() {\n      return onCloseCallback();\n    }\n  }, userDetails))) : null));\n};\n\nexports.UserList = UserList;\nUserList.defaultProps = defaultProps;\n\nvar mapStateToProps = function mapStateToProps(state) {\n  var extraData = (0, _sessionReducer.getExtraData)(state);\n  return {\n    extraData: extraData\n  };\n};\n\nvar mapDispatchToProps = {\n  fetchKeycloakUsersCreator: _user.fetchKeycloakUsers,\n  removeKeycloakUsersCreator: _user.removeKeycloakUsers\n};\nvar ConnectedUserList = (0, _reactRedux.connect)(mapStateToProps, mapDispatchToProps)(UserList);\nexports.ConnectedUserList = ConnectedUserList;","map":null,"metadata":{},"sourceType":"script"}