{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.fetchState = void 0;\nexports.fetchUser = fetchUser;\nexports.oauth2Callback = oauth2Callback;\nexports.refreshToken = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _sessionReducer = require(\"@onaio/session-reducer\");\n\nvar _gatekeeper = require(\"../ducks/gatekeeper\");\n\nvar _constants = require(\"./constants\");\n\nvar _oauth = require(\"./oauth\");\n\nvar _utils = require(\"./utils\");\n\nfunction oauth2Callback(_x, _x2, _x3, _x4) {\n  return _oauth2Callback.apply(this, arguments);\n}\n\nfunction _oauth2Callback() {\n  _oauth2Callback = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee4(urlObject, url, provider, userInfoCallback) {\n    var method,\n        _args4 = arguments;\n    return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            method = _args4.length > 4 && _args4[4] !== undefined ? _args4[4] : 'GET';\n            return _context4.abrupt(\"return\", provider.token.getToken(urlObject).then(function () {\n              var _ref5 = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee3(oAuthObject) {\n                var response, data;\n                return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                  while (1) {\n                    switch (_context3.prev = _context3.next) {\n                      case 0:\n                        _context3.next = 2;\n                        return fetch(url, oAuthObject.sign({\n                          method: method,\n                          url: url\n                        }));\n\n                      case 2:\n                        response = _context3.sent;\n\n                        if (response.ok) {\n                          _context3.next = 5;\n                          break;\n                        }\n\n                        throw new Error(\"\".concat(_constants.OAUTH2_HTTP_ERROR, \" \").concat(response.status));\n\n                      case 5:\n                        _context3.next = 7;\n                        return response.json();\n\n                      case 7:\n                        data = _context3.sent;\n                        data.oAuth2Data = oAuthObject.data;\n                        return _context3.abrupt(\"return\", userInfoCallback(data));\n\n                      case 10:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }\n                }, _callee3);\n              }));\n\n              return function (_x13) {\n                return _ref5.apply(this, arguments);\n              };\n            }()));\n\n          case 2:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n  return _oauth2Callback.apply(this, arguments);\n}\n\nfunction fetchUser(_x5, _x6, _x7) {\n  return _fetchUser.apply(this, arguments);\n}\n\nfunction _fetchUser() {\n  _fetchUser = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee5(urlObject, resourceUrl, provider) {\n    var authenticateActionCreator,\n        recordResultActionCreator,\n        userInfoCallback,\n        errorCallbackFn,\n        method,\n        responseInfo,\n        authenticated,\n        user,\n        extraData,\n        _args5 = arguments;\n    return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            authenticateActionCreator = _args5.length > 3 && _args5[3] !== undefined ? _args5[3] : _sessionReducer.authenticateUser;\n            recordResultActionCreator = _args5.length > 4 && _args5[4] !== undefined ? _args5[4] : _gatekeeper.recordResult;\n            userInfoCallback = _args5.length > 5 && _args5[5] !== undefined ? _args5[5] : _oauth.getOnadataUserInfo;\n            errorCallbackFn = _args5.length > 6 && _args5[6] !== undefined ? _args5[6] : _utils.errorCallback;\n            method = _args5.length > 7 && _args5[7] !== undefined ? _args5[7] : 'GET';\n            _context5.prev = 5;\n            _context5.next = 8;\n            return oauth2Callback(urlObject, resourceUrl, provider, userInfoCallback, method);\n\n          case 8:\n            responseInfo = _context5.sent;\n\n            if (responseInfo) {\n              authenticated = responseInfo.authenticated, user = responseInfo.user, extraData = responseInfo.extraData;\n              authenticateActionCreator(authenticated, user, extraData);\n              recordResultActionCreator(true, extraData);\n            } else {\n              recordResultActionCreator(false, {\n                error: _constants.GENERIC_ERROR\n              });\n              errorCallbackFn(_constants.GENERIC_ERROR);\n            }\n\n            _context5.next = 16;\n            break;\n\n          case 12:\n            _context5.prev = 12;\n            _context5.t0 = _context5[\"catch\"](5);\n            recordResultActionCreator(false, {\n              error: _context5.t0\n            });\n\n            if (_context5.t0 instanceof Error) {\n              errorCallbackFn(_context5.t0.message);\n            }\n\n          case 16:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5, null, [[5, 12]]);\n  }));\n  return _fetchUser.apply(this, arguments);\n}\n\nvar fetchState = function () {\n  var _ref2 = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee(url, _ref) {\n    var _ref$authenticateActi, authenticateActionCreator, _ref$recordResultActi, recordResultActionCreator, _ref$authenticationPr, authenticationProgressCreator, _ref$errorCallbackFn, errorCallbackFn, _ref$logoutActionCrea, logoutActionCreator;\n\n    return _regenerator[\"default\"].wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _ref$authenticateActi = _ref.authenticateActionCreator, authenticateActionCreator = _ref$authenticateActi === void 0 ? _sessionReducer.authenticateUser : _ref$authenticateActi, _ref$recordResultActi = _ref.recordResultActionCreator, recordResultActionCreator = _ref$recordResultActi === void 0 ? _gatekeeper.recordResult : _ref$recordResultActi, _ref$authenticationPr = _ref.authenticationProgressCreator, authenticationProgressCreator = _ref$authenticationPr === void 0 ? _gatekeeper.authenticationProgress : _ref$authenticationPr, _ref$errorCallbackFn = _ref.errorCallbackFn, errorCallbackFn = _ref$errorCallbackFn === void 0 ? _utils.errorCallback : _ref$errorCallbackFn, _ref$logoutActionCrea = _ref.logoutActionCreator, logoutActionCreator = _ref$logoutActionCrea === void 0 ? _sessionReducer.logOutUser : _ref$logoutActionCrea;\n            authenticationProgressCreator(true);\n            fetch(url).then(function (res) {\n              if (res.ok) {\n                return res.json();\n              }\n\n              authenticationProgressCreator(false);\n              throw new Error('fetching state failed');\n            }).then(function (data) {\n              var session = data.session;\n\n              if (!session) {\n                logoutActionCreator();\n                throw new Error('User is logged out');\n              }\n\n              var authenticated = session.authenticated,\n                  user = session.user,\n                  extraData = session.extraData;\n              authenticateActionCreator(authenticated, user, extraData);\n              recordResultActionCreator(true, extraData);\n              authenticationProgressCreator(false);\n            })[\"catch\"](function (err) {\n              recordResultActionCreator(false, {\n                err: err\n              });\n              authenticationProgressCreator(false);\n              errorCallbackFn(err);\n            });\n\n          case 3:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function fetchState(_x8, _x9) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nexports.fetchState = fetchState;\n\nvar refreshToken = function () {\n  var _ref4 = (0, _asyncToGenerator2[\"default\"])(_regenerator[\"default\"].mark(function _callee2(url, dispatch, _ref3) {\n    var _ref3$authenticateAct, authenticateActionCreator, _ref3$errorCallbackFn, errorCallbackFn, _ref3$recordResultAct, recordResultActionCreator;\n\n    return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _ref3$authenticateAct = _ref3.authenticateActionCreator, authenticateActionCreator = _ref3$authenticateAct === void 0 ? _sessionReducer.authenticateUser : _ref3$authenticateAct, _ref3$errorCallbackFn = _ref3.errorCallbackFn, errorCallbackFn = _ref3$errorCallbackFn === void 0 ? _utils.errorCallback : _ref3$errorCallbackFn, _ref3$recordResultAct = _ref3.recordResultActionCreator, recordResultActionCreator = _ref3$recordResultAct === void 0 ? _gatekeeper.recordResult : _ref3$recordResultAct;\n            return _context2.abrupt(\"return\", fetch(url).then(function (res) {\n              if (res.ok) {\n                return res.json();\n              }\n\n              throw new Error(_constants.TOKEN_REFRESH_FAILED);\n            }).then(function (data) {\n              var _extraData$oAuth2Data;\n\n              var session = data.session;\n\n              if (!session) {\n                throw new Error(_constants.TOKEN_REFRESH_FAILED);\n              }\n\n              var authenticated = session.authenticated,\n                  user = session.user,\n                  extraData = session.extraData;\n              var access_token = extraData === null || extraData === void 0 || (_extraData$oAuth2Data = extraData.oAuth2Data) === null || _extraData$oAuth2Data === void 0 ? void 0 : _extraData$oAuth2Data.access_token;\n              dispatch(authenticateActionCreator(authenticated, user, extraData));\n              dispatch(recordResultActionCreator(true, extraData));\n              return access_token;\n            })[\"catch\"](function (err) {\n              errorCallbackFn(err);\n            }));\n\n          case 2:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function refreshToken(_x10, _x11, _x12) {\n    return _ref4.apply(this, arguments);\n  };\n}();\n\nexports.refreshToken = refreshToken;","map":null,"metadata":{},"sourceType":"script"}