{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getOnadataUserInfo = getOnadataUserInfo;\nexports.getOpenSRPUserInfo = getOpenSRPUserInfo;\nexports.getProviderFromOptions = getProviderFromOptions;\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _clientOauth = _interopRequireDefault(require(\"client-oauth2\"));\n\nvar _jsonwebtoken = _interopRequireDefault(require(\"jsonwebtoken\"));\n\nvar _constants = require(\"./constants\");\n\nfunction ownKeys(e, r) {\n  var t = Object.keys(e);\n\n  if (Object.getOwnPropertySymbols) {\n    var o = Object.getOwnPropertySymbols(e);\n    r && (o = o.filter(function (r) {\n      return Object.getOwnPropertyDescriptor(e, r).enumerable;\n    })), t.push.apply(t, o);\n  }\n\n  return t;\n}\n\nfunction _objectSpread(e) {\n  for (var r = 1; r < arguments.length; r++) {\n    var t = null != arguments[r] ? arguments[r] : {};\n    r % 2 ? ownKeys(Object(t), !0).forEach(function (r) {\n      (0, _defineProperty2[\"default\"])(e, r, t[r]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) {\n      Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r));\n    });\n  }\n\n  return e;\n}\n\nfunction getProviderFromOptions(options) {\n  var accessTokenUri = options.accessTokenUri,\n      authorizationUri = options.authorizationUri,\n      clientId = options.clientId,\n      redirectUri = options.redirectUri,\n      scopes = options.scopes,\n      state = options.state;\n  return new _clientOauth[\"default\"]({\n    accessTokenUri: accessTokenUri,\n    authorizationUri: authorizationUri,\n    clientId: clientId,\n    redirectUri: redirectUri,\n    scopes: scopes,\n    state: state\n  });\n}\n\nfunction getOnadataUserInfo(apiResponse) {\n  if (!apiResponse.username || !apiResponse.api_token) {\n    throw new Error(_constants.OAUTH2_CALLBACK_ERROR);\n  }\n\n  return {\n    authenticated: true,\n    extraData: apiResponse,\n    user: {\n      email: apiResponse.email || '',\n      gravatar: apiResponse.gravatar || '',\n      name: apiResponse.name || '',\n      username: apiResponse.username\n    }\n  };\n}\n\nvar addSecToCurrentTime = function addSecToCurrentTime(seconds, baseDate) {\n  var date = baseDate && !isNaN(baseDate.getTime()) ? baseDate : new Date(Date.now());\n  return !isNaN(Number(seconds)) ? new Date(date.setSeconds(date.getSeconds() + Number(seconds))).toISOString() : null;\n};\n\nfunction getOpenSRPUserInfo(apiRes) {\n  var _realm_access$roles;\n\n  var accessToken = apiRes.oAuth2Data.access_token;\n\n  if (!accessToken) {\n    throw new Error(_constants.OAUTH2_CALLBACK_ERROR);\n  }\n\n  var tokenClaims = _jsonwebtoken[\"default\"].decode(accessToken);\n\n  if (!tokenClaims) {\n    throw new Error(_constants.OAUTH2_CALLBACK_ERROR);\n  }\n\n  var email_verified = tokenClaims.email_verified,\n      given_name = tokenClaims.given_name,\n      family_name = tokenClaims.family_name,\n      preferred_username = tokenClaims.preferred_username,\n      realm_access = tokenClaims.realm_access,\n      resource_access = tokenClaims.resource_access,\n      sub = tokenClaims.sub,\n      name = tokenClaims.name;\n  var resourceAccessRoles = {};\n  Object.entries(resource_access !== null && resource_access !== void 0 ? resource_access : {}).forEach(function (_ref) {\n    var _ref2 = (0, _slicedToArray2[\"default\"])(_ref, 2),\n        clientID = _ref2[0],\n        rolesObj = _ref2[1];\n\n    resourceAccessRoles[clientID] = rolesObj.roles;\n  });\n  var apiResponse = {\n    roles: {\n      realmAccess: (_realm_access$roles = realm_access === null || realm_access === void 0 ? void 0 : realm_access.roles) !== null && _realm_access$roles !== void 0 ? _realm_access$roles : [],\n      clientRoles: resourceAccessRoles\n    },\n    email: null,\n    username: preferred_username,\n    user_id: sub,\n    preferred_name: name,\n    family_name: family_name,\n    given_name: given_name,\n    email_verified: email_verified,\n    oAuth2Data: apiRes.oAuth2Data\n  };\n  var _apiResponse$oAuth2Da = apiResponse.oAuth2Data,\n      expires_in = _apiResponse$oAuth2Da.expires_in,\n      refresh_expires_in = _apiResponse$oAuth2Da.refresh_expires_in;\n  var authTime = new Date(tokenClaims.iat * 1000);\n  var tokenExpiryTime = addSecToCurrentTime(expires_in, authTime);\n  var refreshExpiryTime = addSecToCurrentTime(refresh_expires_in, authTime);\n\n  var responseCopy = _objectSpread({}, apiResponse);\n\n  responseCopy = _objectSpread(_objectSpread({}, responseCopy), {}, {\n    oAuth2Data: _objectSpread(_objectSpread(_objectSpread({}, apiResponse.oAuth2Data), tokenExpiryTime && {\n      token_expires_at: tokenExpiryTime\n    }), refreshExpiryTime && {\n      refresh_expires_at: refreshExpiryTime\n    })\n  });\n  return {\n    authenticated: true,\n    extraData: responseCopy,\n    user: {\n      email: '',\n      gravatar: '',\n      name: '',\n      username: apiResponse.username\n    }\n  };\n}","map":null,"metadata":{},"sourceType":"script"}